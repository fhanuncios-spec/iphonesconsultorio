<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de iPhones</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial;
  background: #f2f2f7;
  padding: 12px;
}

/* ===== TOPO ===== */
.header {
  background: #0f172a;
  color: #fff;
  padding: 14px;
  border-radius: 14px;
  margin-bottom: 12px;
  text-align: center;
}

.header .resumo-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 10px;
}

.header .box {
  background: #1e293b;
  padding: 10px;
  border-radius: 10px;
  font-size: 13px;
}

#resumoVendedor {
  margin-top: 10px;
  background: #22c55e;
  color: #ffffff;
  padding: 10px;
  border-radius: 10px;
  font-size: 13px;
  display: none;
}

/* ===== FILTROS ===== */
.filtros {
  background: #fff;
  padding: 12px;
  border-radius: 14px;
  margin-bottom: 12px;
}

select, input {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #ddd;
}

/* ===== LISTA ===== */
#lista {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

@media (max-width: 380px) {
  #lista {
    grid-template-columns: 1fr;
  }
}

/* ===== CARD ===== */
.card {
  background: #fff;
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,.06);
}

.card.disponivel {
  background: #16a34a;
  color: #ffffff;
}

.card.disponivel .info div {
  background: rgba(255,255,255,0.15);
  color: #ffffff;
}

.card h3 {
  margin: 0 0 6px 0;
  font-size: 14px;
}

.tags {
  font-size: 11px;
  margin-bottom: 6px;
}

.tag {
  padding: 4px 6px;
  border-radius: 6px;
  font-weight: bold;
}

.entrada { background: #e0f2fe; color: #0369a1; }
.vendido { background: #dcfce7; color: #166534; }
.nao { background: #15803d; color: #ffffff; }

.info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  font-size: 12px;
}

.info div {
  background: #f7f7f7;
  padding: 6px;
  border-radius: 6px;
}

.lucro {
  margin-top: 8px;
  padding: 8px;
  border-radius: 10px;
  background: #0f172a;
  color: #ffffff;
  font-weight: bold;
  text-align: center;
  font-size: 13px;
}
</style>
</head>

<body>

<div class="header">
  <h3 id="lucroMes">üí∞ Selecione um m√™s</h3>

  <div class="resumo-grid">
    <div class="box" id="totalGeral">Total: 0</div>
    <div class="box" id="totalVendidos">Vendidos: 0</div>
    <div class="box" id="totalDisponiveis">Dispon√≠veis: 0</div>
  </div>

  <div id="resumoVendedor"></div>
</div>

<div class="filtros">
  <select id="vendedor"></select>

  <select id="status">
    <option value="">Todos</option>
    <option value="SIM">Somente vendidos</option>
    <option value="NAO">Somente dispon√≠veis</option>
  </select>

  <input type="month" id="mes">
</div>

<div id="lista"></div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwuroYkA_84ft4-fCOheB7_euWSHZrNuPlX_mZA97zekM2KAAss-7LCGhPhL401SQ2E/exec";
let dados = [];

fetch(URL)
  .then(r => r.json())
  .then(r => {
    dados = r;
    carregarVendedores();
    render();
  });

document.getElementById("vendedor").onchange = render;
document.getElementById("status").onchange = render;
document.getElementById("mes").onchange = render;

function carregarVendedores() {
  const select = document.getElementById("vendedor");
  const vendedores = [...new Set(dados.slice(1).map(l => l[1]).filter(Boolean))];

  select.innerHTML = `<option value="">Todos vendedores</option>`;
  vendedores.forEach(v => {
    select.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

/* Parse robusto: Date, ISO, e BR dd/mm/aaaa */
function parseDate(value) {
  if (!value) return null;

  if (Object.prototype.toString.call(value) === "[object Date]") {
    return isNaN(value) ? null : value;
  }

  // Tenta ISO / formatos padr√£o
  const d1 = new Date(value);
  if (!isNaN(d1)) return d1;

  // Tenta dd/mm/aaaa ou dd-mm-aaaa
  const s = String(value).trim();
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const dd = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10) - 1;
    let yy = parseInt(m[3], 10);
    if (yy < 100) yy += 2000;
    const d2 = new Date(yy, mm, dd);
    return isNaN(d2) ? null : d2;
  }

  return null;
}

function formatarData(data) {
  const d = parseDate(data);
  if (!d) return "-";
  return d.toLocaleDateString("pt-BR");
}

function getMesYYYYMM(dateValue) {
  const d = parseDate(dateValue);
  if (!d) return "";
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2,"0")}`;
}

function render() {
  const lista = document.getElementById("lista");
  const vendedorFiltro = document.getElementById("vendedor").value;
  const statusFiltro = document.getElementById("status").value;
  const mesFiltro = document.getElementById("mes").value;

  lista.innerHTML = "";

  let total = 0, vendidos = 0, disponiveis = 0;
  let lucroMes = 0, lucroVendedor = 0, vendidosVendedor = 0;

  // 1) Monta uma lista de itens filtrados (para ordenar antes de renderizar)
  const itens = [];

  dados.slice(1).forEach(l => {
    const vendedor = l[1];
    const vendido = (l[11] || "").toUpperCase() === "SIM" ? "SIM" : "NAO";

    if (vendedorFiltro && vendedorFiltro !== vendedor) return;
    if (statusFiltro === "SIM" && vendido !== "SIM") return;
    if (statusFiltro === "NAO" && vendido === "SIM") return;

    total++;
    vendido === "SIM" ? vendidos++ : disponiveis++;

    const cliente = l[2] || "-";
    const dataEntrada = formatarData(l[0]);
    const dataVenda = formatarData(l[13]);

    const valorEntrada = Number(l[8]) || 0;
    const custoReparo = Number(l[9]) || 0;
    const valorVenda = Number(l[10]) || 0;
    const custosAdicionais = Number(l[12]) || 0;

    const lucro = valorVenda - valorEntrada - custoReparo - custosAdicionais;

    const mesVenda = getMesYYYYMM(l[13]);

    // ‚úÖ LUCRO DO M√äS: SOMENTE VENDIDOS NO M√äS SELECIONADO
    if (vendido === "SIM" && mesFiltro && mesVenda === mesFiltro) {
      lucroMes += lucro;
    }

    // ‚úÖ RESUMO DO VENDEDOR: SE TIVER M√äS SELECIONADO, CONSIDERA S√ì AQUELE M√äS
    if (vendido === "SIM" && vendedorFiltro === vendedor) {
      if (!mesFiltro || mesVenda === mesFiltro) {
        vendidosVendedor++;
        lucroVendedor += lucro;
      }
    }

    itens.push({
      row: l,
      vendido,
      cliente,
      dataEntrada,
      dataVenda,
      valorEntrada,
      custoReparo,
      valorVenda,
      custosAdicionais,
      lucro,
      dataEntradaTS: (parseDate(l[0]) ? parseDate(l[0]).getTime() : 0)
    });
  });

  // 2) Ordena: Dispon√≠veis primeiro, depois por DataEntrada (desc) em cada grupo
  itens.sort((a, b) => {
    // Dispon√≠vel (NAO) primeiro
    const ga = (a.vendido === "NAO") ? 0 : 1;
    const gb = (b.vendido === "NAO") ? 0 : 1;
    if (ga !== gb) return ga - gb;

    // Dentro do grupo: DataEntrada mais recente primeiro
    return (b.dataEntradaTS || 0) - (a.dataEntradaTS || 0);
  });

  // 3) Renderiza j√° ordenado
  itens.forEach(item => {
    const l = item.row;

    lista.innerHTML += `
      <div class="card ${item.vendido === "NAO" ? "disponivel" : ""}">
        <h3>üì± ${l[4]} ‚Ä¢ ${l[5]}</h3>

        <div class="tags">
          <span class="tag entrada">${l[3]}</span>
          <span class="tag ${item.vendido === "SIM" ? "vendido" : "nao"}">
            ${item.vendido === "SIM" ? "VENDIDO" : "DISPON√çVEL"}
          </span>
        </div>

        <div class="info">
          <div><b>Cliente:</b> ${item.cliente}</div>
          <div><b>Bateria:</b> ${l[7]}%</div>
          <div><b>Compra:</b> ${item.dataEntrada}</div>
          <div><b>Venda:</b> ${item.dataVenda}</div>
          <div><b>Pago:</b> R$ ${item.valorEntrada}</div>
          <div><b>Valor venda:</b> R$ ${item.valorVenda}</div>
          <div><b>Reparo:</b> R$ ${item.custoReparo}</div>
          <div><b>Adicional:</b> R$ ${item.custosAdicionais}</div>
        </div>

        <div class="lucro">üí∞ Lucro: R$ ${item.lucro}</div>
      </div>
    `;
  });

  document.getElementById("totalGeral").innerText = `Total: ${total}`;
  document.getElementById("totalVendidos").innerText = `Vendidos: ${vendidos}`;
  document.getElementById("totalDisponiveis").innerText = `Dispon√≠veis: ${disponiveis}`;

  document.getElementById("lucroMes").innerText =
    mesFiltro ? `üí∞ Lucro total do m√™s: R$ ${lucroMes}` : "üí∞ Selecione um m√™s";

  const resumo = document.getElementById("resumoVendedor");
  if (vendedorFiltro) {
    resumo.style.display = "block";
    resumo.innerText =
      `üë§ ${vendedorFiltro} ‚Ä¢ Vendidos: ${vendidosVendedor} ‚Ä¢ Comiss√£o: R$ ${vendidosVendedor * 30} ‚Ä¢ Lucro: R$ ${lucroVendedor}`;
  } else {
    resumo.style.display = "none";
  }
}
</script>

</body>
</html>
