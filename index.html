<script>
const URL = "https://script.google.com/macros/s/AKfycbwuroYkA_84ft4-fCOheB7_euWSHZrNuPlX_mZA97zekM2KAAss-7LCGhPhL401SQ2E/exec";
let dados = [];

fetch(URL)
  .then(r => r.json())
  .then(r => {
    dados = r;
    carregarVendedores();
    render();
  });

document.getElementById("vendedor").onchange = render;
document.getElementById("mes").onchange = render;
document.getElementById("status").onchange = render;

function carregarVendedores() {
  const select = document.getElementById("vendedor");
  const vendedores = [...new Set(dados.slice(1).map(l => l[1]).filter(Boolean))];

  select.innerHTML = `<option value="">Todos vendedores</option>`;
  vendedores.forEach(v => {
    select.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

function render() {
  const lista = document.getElementById("lista");
  const vendedorFiltro = document.getElementById("vendedor").value;
  const mesFiltro = document.getElementById("mes").value;
  const statusFiltro = document.getElementById("status").value;

  lista.innerHTML = "";

  let total = 0, vendidos = 0, disponiveis = 0;
  let lucroTotalMes = 0;
  let vendidosVendedor = 0;
  let lucroVendedor = 0;

  dados.slice(1).forEach(l => {
    const vendedor = l[1];
    const vendido = (l[11] || "").toUpperCase() === "SIM" ? "SIM" : "NAO";

    if (vendedorFiltro && vendedorFiltro !== vendedor) return;
    if (statusFiltro === "SIM" && vendido !== "SIM") return;
    if (statusFiltro === "NAO" && vendido === "SIM") return;

    total++;
    vendido === "SIM" ? vendidos++ : disponiveis++;

    const valorEntrada = Number(l[8]) || 0;
    const custoReparo = Number(l[9]) || 0;
    const valorVenda = Number(l[10]) || 0;
    const custosAdicionais = Number(l[12]) || 0;

    const lucro = valorVenda - valorEntrada - custoReparo - custosAdicionais;

    // ğŸ“… FILTRO DE MÃŠS (DATA DE VENDA)
    let mesVenda = "";
    if (l[13]) {
      const d = new Date(l[13]);
      mesVenda = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }

    // ğŸ”¥ LUCRO TOTAL DO MÃŠS (APENAS VENDIDOS)
    if (vendido === "SIM" && mesFiltro && mesVenda === mesFiltro) {
      lucroTotalMes += lucro;
    }

    // ğŸ‘¤ DADOS DO VENDEDOR SELECIONADO
    if (vendido === "SIM" && vendedorFiltro && vendedorFiltro === vendedor) {
      vendidosVendedor++;
      lucroVendedor += lucro;
    }

    lista.innerHTML += `
      <div class="card ${vendido === "NAO" ? "disponivel" : ""}">
        <h3>ğŸ“± ${l[4]} â€¢ ${l[5]}</h3>

        <div class="tags">
          <span class="tag entrada">${l[3]}</span>
          <span class="tag ${vendido === "SIM" ? "vendido" : "nao"}">
            ${vendido === "SIM" ? "VENDIDO" : "DISPONÃVEL"}
          </span>
        </div>

        <div class="info">
          <div><b>Bateria:</b> ${l[7]}%</div>
          <div><b>Entrada:</b> R$ ${valorEntrada}</div>
          <div><b>Reparo:</b> R$ ${custoReparo}</div>
          <div><b>Adicional:</b> R$ ${custosAdicionais}</div>
        </div>

        <div class="lucro">ğŸ’° Lucro: R$ ${lucro}</div>
      </div>
    `;
  });

  document.getElementById("totalGeral").innerText = `Total: ${total}`;
  document.getElementById("totalVendidos").innerText = `Vendidos: ${vendidos}`;
  document.getElementById("totalDisponiveis").innerText = `DisponÃ­veis: ${disponiveis}`;

  // ğŸ’° TOPO â€“ LUCRO DO MÃŠS
  document.getElementById("lucroMes").innerText =
    mesFiltro
      ? `ğŸ’° Lucro total do mÃªs: R$ ${lucroTotalMes}`
      : "ğŸ’° Selecione um mÃªs";

  // ğŸ‘¤ RESUMO DO VENDEDOR
  const comissaoBox = document.getElementById("comissaoVendedor");
  if (vendedorFiltro) {
    const comissao = vendidosVendedor * 30;
    comissaoBox.style.display = "block";
    comissaoBox.innerText =
      `ğŸ‘¤ ${vendedorFiltro} â€¢ Vendidos: ${vendidosVendedor} â€¢ ComissÃ£o: R$ ${comissao} â€¢ Lucro: R$ ${lucroVendedor}`;
  } else {
    comissaoBox.style.display = "none";
  }
}
</script>
